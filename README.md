# PR Webhook Automation

Automate PR workflows with Claude Code using a plan-driven development approach.

## Workflow

1. **Planning** — Make a detailed plan, a markdown file in `docs/plans/` folder that can be generated by `/superpowers:brainstorming` in claude code interactively.
2. **Plan** — Run `/superpowers:writing-plans` to generate a detailed implementation plan.
3. **Push & open PR** — Push the plan to a new branch and create a PR (plan file in the repo).
4. **Execute** — Comment `[action]` on the PR; Claude executes the plan (subagent-driven) and pushes commits.
5. **Review** — Review the changes; comment `[fix]` to have Claude address review comments.
6. **Repeat** — Repeat steps 4–5 until ready to merge.

## Features

- **Event-driven**: GitHub webhooks trigger jobs instantly (no polling)
- **Reliable**: SQLite job queue with deduplication and failure handling
- **Secure**: HMAC signature verification, configurable user allowlist
- **Simple**: Single Python server, no external dependencies beyond `cloudflared`

## Quick Start

```bash
# 1. Clone and setup
git clone https://github.com/user/pr-resolver.git
cd pr-resolver
make setup

# 2. Start services
make services-start

# 3. Verify
make status
```

## PR Commands

Comment on any PR to trigger automation:

| Command | Action |
|---------|--------|
| `[action]` | Execute the plan file |
| `[fix]` | Address review comments |
| `[status]` | Check queue status |
| `[debug]` | Test the full pipeline |

Plan files are detected in order: `PLAN.md`, `plan.md`, `.claude/plan.md`, `docs/plan.md`, or any file in `docs/plans/*.md`.

## Architecture

```
GitHub PR Comment
       │
       ▼
GitHub Webhook ──► Cloudflare Tunnel ──► Webhook Server ──► Job Queue ──► Claude
                                              │                              │
                                              └────── Status Comments ◄──────┘
```

## Configuration

After `make setup`, edit `.claude/webhook/config.toml`:

```toml
[github]
username = "your-username"      # Only your comments trigger jobs
webhook_secret = "..."          # Generated during setup

[worker]
timeout_minutes = 30            # Max job runtime
max_turns = 100                 # Max Claude API turns

# Option 1: List repos explicitly
[[repos]]
github = "owner/repo"
path = "~/projects/repo"

# Option 2: Watch all repos in a directory
[repos_dir]
path = "~/projects"
max_depth = 2
```

## Make Targets

```bash
make help              # Show all targets

# Setup
make setup             # Full setup wizard
make install-deps      # Install Python dependencies

# Services (launchd)
make services-start    # Start webhook + tunnel
make services-stop     # Stop all services
make services-status   # Check status

# Manual (for testing)
make webhook-start     # Start webhook server
make tunnel-start      # Start tunnel

# Monitoring
make status            # Health check
make logs              # Tail all logs
```

## Adding Webhooks

Use the GitHub CLI to add webhooks:

```bash
WEBHOOK_URL="https://your-tunnel.trycloudflare.com/webhook"
SECRET=$(grep webhook_secret .claude/webhook/config.toml | cut -d'"' -f2)

gh api repos/OWNER/REPO/hooks --method POST --input - <<EOF
{"config":{"url":"$WEBHOOK_URL","content_type":"json","secret":"$SECRET"},"events":["issue_comment"],"active":true}
EOF
```

Or add webhooks for all repos in a directory:

```bash
for dir in ~/projects/*/; do
  repo=$(cd "$dir" && git remote get-url origin 2>/dev/null | sed -E 's|.*github.com[:/]||;s|\.git$||')
  [ -n "$repo" ] && gh api "repos/$repo/hooks" --method POST --input - <<EOF
{"config":{"url":"$WEBHOOK_URL","content_type":"json","secret":"$SECRET"},"events":["issue_comment"],"active":true}
EOF
done
```

## Directory Structure

```
pr-resolver/
├── .claude/
│   ├── webhook/
│   │   ├── server.py          # FastAPI server + worker
│   │   ├── config.toml        # Your config (git-ignored)
│   │   └── config.example.toml
│   ├── scripts/
│   │   ├── setup-webhook.sh   # Setup wizard
│   │   └── start-tunnel.sh    # Quick tunnel helper
│   ├── launchd/               # macOS service plists
│   └── logs/                  # Log files (git-ignored)
├── docs/plans/                # Design documents
├── Makefile
├── CLAUDE.md
└── README.md
```

## Requirements

- Python 3.9+
- [Claude Code CLI](https://claude.ai/code)
- [GitHub CLI](https://cli.github.com/) (`gh`)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/) (`cloudflared`)

## GitHub Actions (Recommended)

Use GitHub Actions for simpler setup - no webhook server or tunnel needed.

### Setup

1. **Copy workflow to your repo:**
   ```bash
   mkdir -p .github/workflows
   cp /path/to/pr-resolver/.github/workflows/pr-automation.yml .github/workflows/
   git add .github/workflows && git commit -m "Add PR automation workflow" && git push
   ```

2. **Configure runner** (choose one):

   | Runner | Setup | API Key |
   |--------|-------|---------|
   | **Self-hosted** | [Add runner](https://docs.github.com/en/actions/hosting-your-own-runners) to your repo | Set in `~/actions-runner/.env` |
   | **GitHub-hosted** | Change `runs-on: self-hosted` to `runs-on: ubuntu-latest` | Set in repo secrets |

3. **Comment `[action]` on any PR** - workflow triggers automatically

### Self-hosted Runner Setup (macOS)

```bash
# Download and configure
mkdir -p ~/actions-runner && cd ~/actions-runner
curl -O -L https://github.com/actions/runner/releases/download/v2.321.0/actions-runner-osx-arm64-2.321.0.tar.gz
tar xzf actions-runner-osx-arm64-2.321.0.tar.gz
./config.sh --url https://github.com/OWNER/REPO --token YOUR_TOKEN

# Add API key
echo "ANTHROPIC_API_KEY=sk-ant-..." >> .env

# Install and start as service
./svc.sh install && ./svc.sh start
```

### GitHub-hosted Runner Setup

1. Edit workflow: change `runs-on: self-hosted` to `runs-on: ubuntu-latest`
2. Add secret: Settings → Secrets → Actions → `ANTHROPIC_API_KEY`

### Status Checks

The workflow reports status directly on the PR (pending → success/failure), visible in the PR's checks section.

## Troubleshooting

### Cloudflare Login Zone Selection

When `cloudflared tunnel login` asks you to select a zone, pick **any zone** you have access to. This is just for authentication.

### PATH Issues in launchd

If `gh` or `claude` commands fail, ensure `/opt/homebrew/bin` (or your install path) is in the PATH environment variable in the launchd plist.

### Quick Tunnel Mode (Alternative)

If you cannot use named tunnels (e.g., Cloudflare Universal SSL unavailable in your region), use Quick Tunnel mode:

```bash
.claude/scripts/start-tunnel.sh
```

This script:
1. Starts a Quick Tunnel (URL changes on restart)
2. Automatically updates all GitHub webhook URLs
3. Prints the new tunnel URL

Run this script each time you restart the tunnel.

## License

MIT
